<?php
class FormulaireExploitation extends Zend_Form{

	private $_ligne;
	private $_vol;
	
	public function __construct($options = NULL){
		$params = Zend_Controller_Front::getInstance()->getRequest()->getParams();
		
		$this->_ligne = (isset($params['ligne'])) ? $params['ligne'] : false;
		$this->_vol = (isset($params['vol'])) ? $params['vol'] : false;
		
		parent::__construct($options);
	}

	public function init(){
		
		$tableVol = new Vol();
		$tablePays = new Pays();
		$tableVille = new Ville();
		$tableAeroport = new Aeroport();
		
		$infos = ($this->_ligne != false && $this->_vol != false) ? $tableVol->getInfosEffectives($this->_ligne, $this->_vol) : null;
		
		$listePays = $tablePays->getPaysWithOrder('nom asc');
		$villesDep = $tableVille->getVillesByIdPays($infos['codePaysDep']);
		$villesArr = $tableVille->getVillesByIdPays($infos['codePaysArr']);
		$aeroportDep = $tableAeroport->getAeroportByVille($infos['codeVilleDep']);
		$aeroportArr = $tableAeroport->getAeroportByVille($infos['codeVilleArr']);
		
		$EPaysDep = new Zend_Form_Element_Select('paysDepart');
		$EPaysArr = new Zend_Form_Element_Select('paysArrivee');
		
		$EVilleDep = new Zend_Form_Element_Select('villeDepart');
		$EVilleArr = new Zend_Form_Element_Select('villeArrivee');
		
		$EAeroportDep = new Zend_Form_Element_Select('aeroportDepart');
		$EAeroportArr = new Zend_Form_Element_Select('aeroportArrivee');
		
		$EHeure = new Zend_Form_Element_Text('heureArrivee');

		$ESubmit = new Zend_Form_Element_Submit('bouton');
		
		foreach($listePays as $pays){
			$EPaysDep->addMultiOption($pays->code_pays, $pays->nom);
			$EPaysArr->addMultiOption($pays->code_pays, $pays->nom);
		}
		
		foreach($villesDep as $ville){
			$EVilleDep->addMultiOption($ville->code_ville, $ville->nom);
		}
		
		foreach($villesArr as $ville){
			$EVilleArr->addMultiOption($ville->code_ville, $ville->nom);
		}
		
		foreach($aeroportDep as $aeroport){
			$EAeroportDep->addMultiOption($aeroport->id_aeroport, $aeroport->nom);
		}
		
		foreach($aeroportArr as $aeroport){
			$EAeroportArr->addMultiOption($aeroport->id_aeroport, $aeroport->nom);
		}
		
		$EPaysDep->setValue($infos['codePaysDep']);
		$EPaysArr->setValue($infos['codePaysArr']);
		$EVilleDep->setValue($infos['codeVilleDep']);
		$EVilleArr->setValue($infos['codeVilleArr']);
		$EAeroportDep->setValue($infos['id_aeroport_depart_effectif']);
		$EAeroportArr->setValue($infos['id_aeroport_arrivee_effectif']);
		$EHeure->setValue($infos['heure_arrivee_effective']);
		
		$EPaysDep->setRegisterInArrayValidator(false);
		$EPaysArr->setRegisterInArrayValidator(false);
		$EVilleDep->setRegisterInArrayValidator(false);
		$EVilleArr->setRegisterInArrayValidator(false);
		$EAeroportDep->setRegisterInArrayValidator(false);
		$EAeroportArr->setRegisterInArrayValidator(false);
		
		$EPaysDep->setRequired(true);
		$EPaysArr->setRequired(true);
		$EVilleDep->setRequired(true);
		$EVilleArr->setRequired(true);
		$EAeroportDep->setRequired(true);
		$EAeroportArr->setRequired(true);
		
		$EPaysDep->setAttrib('onchange', 'rechercherVille(this.value, "villeDepart")');
		$EPaysArr->setAttrib('onchange', 'rechercherVille(this.value, "villeArrivee")');
		$EVilleDep->setAttrib('onchange', 'rechercherAeroport(this.value, "aeroportDepart")');
		$EVilleArr->setAttrib('onchange', 'rechercherAeroport(this.value, "aeroportArrivee")');
		
		$EPaysDep->removeDecorator('DtDdWrapper')->removeDecorator('HtmlTag')->removeDecorator('Label');
		$EPaysArr->removeDecorator('DtDdWrapper')->removeDecorator('HtmlTag')->removeDecorator('Label');
		$EVilleDep->removeDecorator('DtDdWrapper')->removeDecorator('HtmlTag')->removeDecorator('Label');
		$EVilleArr->removeDecorator('DtDdWrapper')->removeDecorator('HtmlTag')->removeDecorator('Label');
		$EAeroportDep->removeDecorator('DtDdWrapper')->removeDecorator('HtmlTag')->removeDecorator('Label');
		$EAeroportArr->removeDecorator('DtDdWrapper')->removeDecorator('HtmlTag')->removeDecorator('Label');
		$EHeure->removeDecorator('DtDdWrapper')->removeDecorator('HtmlTag')->removeDecorator('Label');
		$ESubmit->removeDecorator('DtDdWrapper')->removeDecorator('HtmlTag')->removeDecorator('Label');
		
		$ESubmit->setLabel('Modifier');
		
		$this->setMethod('POST');
		$this->setAction('/exploitation/fiche-vol/ligne/'.$this->_ligne.'/vol/'.$this->_vol);
		$this->addElement($EPaysDep);
		$this->addElement($EPaysArr);
		$this->addElement($EVilleDep);
		$this->addElement($EVilleArr);
		$this->addElement($EAeroportDep);
		$this->addElement($EAeroportArr);
		$this->addElement($EHeure);
		$this->addElement($ESubmit);
	}
}